<script type="module">
  import { db } from "/assets/js/firebase-config.js";
  import {
    collection,
    doc,
    getDocs,
    addDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const listingsContainer = document.querySelector(".card-grid");

  async function loadPendingListings() {
    const querySnapshot = await getDocs(collection(db, "listings_requests"));
    listingsContainer.innerHTML = "";

    querySnapshot.forEach((docSnap) => {
      const d = docSnap.data();
      if (d.status !== "pending") return;

      const card = document.createElement("div");
      card.className = "business-card";

      card.innerHTML = `
        <h3>${d.businessName}</h3>
        <p>${d.area}, ${d.city}</p>
        <span class="badge">Pending</span>

        <div class="card-actions">
          <button class="btn btn-primary approve-btn">Approve</button>
          <button class="btn btn-outline edit-btn">Edit</button>
        </div>
      `;

      // APPROVE BUTTON
      card.querySelector(".approve-btn").onclick = async () => {
        await addDoc(collection(db, "listings"), {
          ...d,
          status: "approved"
        });

        await updateDoc(doc(db, "listings_requests", docSnap.id), {
          status: "approved"
        });

        alert("Listing approved & published");
        loadPendingListings();
      };

      // EDIT BUTTON
      card.querySelector(".edit-btn").onclick = () => {
        window.location.href =
          `/admin-dashboard/listings/edit.html?id=${docSnap.id}`;
      };

      listingsContainer.appendChild(card);
    });
  }

  loadPendingListings();
</script>
